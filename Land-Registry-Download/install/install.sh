#!/bin/bash

# TODO: log directory?
# systemctl log redirection?

set -euo pipefail

if [[ "$(id -u)" != "0" ]]; then
    echo "This script must be run as root" >&2
    exit 1
fi

APPLICATION_GROUP_NAME="property-price-land-registry-download"

NAME_CRON_TRIGGER="land_registry_cron_trigger"
NAME_COMPLETE_DOWNLOADER="land_registry_complete_downloader"
NAME_MONTHLY_UPDATE_DOWNLOADER="land_registry_monthly_update_downloader"
NAME_MONTHLY_UPDATE_SHA_CALCULATOR="land_registry_monthly_update_sha256_calculator"
NAME_MONTHLY_UPDATE_DATA_DECISION="land_registry_monthly_update_data_decision"
NAME_MONTHLY_UPDATE_DATABASE_UPDATER="land_registry_monthly_update_database_updater"
NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR="land_registry_monthly_update_garbage_collector"

PROCESS_NAMES=(
    "$NAME_CRON_TRIGGER"
    "$NAME_COMPLETE_DOWNLOADER"
    "$NAME_MONTHLY_UPDATE_DOWNLOADER"
    "$NAME_MONTHLY_UPDATE_SHA_CALCULATOR"
    "$NAME_MONTHLY_UPDATE_DATA_DECISION"
    "$NAME_MONTHLY_UPDATE_DATABASE_UPDATER"
    "$NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR"
)

PYTHON_NAMES=("${PROCESS_NAMES[@]/%/.py}")

SERVICE_FILE_NAMES=("${PROCESS_NAMES[@]/%/.service}")

# PYTHON_NAME_CRON_TRIGGER="$NAME_CRON_TRIGGER.py"
# PYTHON_NAME_COMPLETE_DOWNLOADER="$NAME_COMPLETE_DOWNLOADER.py"
# PYTHON_NAME_MONTHLY_UPDATE_DOWNLOADER="$NAME_MONTHLY_UPDATE_DOWNLOADER.py"
# PYTHON_NAME_MONTHLY_UPDATE_SHA_CALCULATOR="$NAME_MONTHLY_UPDATE_SHA_CALCULATOR.py"
# PYTHON_NAME_MONTHLY_UPDATE_DATA_DECISION="$NAME_MONTHLY_UPDATE_DATA_DECISION.py"
# PYTHON_NAME_MONTHLY_UPDATE_DATABASE_UPDATER="$NAME_MONTHLY_UPDATE_DATABASE_UPDATER.py"
# PYTHON_NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR="$NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR.py"

# SERVICE_FILE_NAME_CRON_TRIGGER="$NAME_CRON_TRIGGER.service"
# SERVICE_FILE_NAME_COMPLETE_DOWNLOADER="$NAME_COMPLETE_DOWNLOADER.service"
# SERVICE_FILE_NAME_MONTHLY_UPDATE_DOWNLOADER="$NAME_MONTHLY_UPDATE_DOWNLOADER.service"
# SERVICE_FILE_NAME_MONTHLY_UPDATE_SHA_CALCULATOR="$NAME_MONTHLY_UPDATE_SHA_CALCULATOR.service"
# SERVICE_FILE_NAME_MONTHLY_UPDATE_DATA_DECISION="$NAME_MONTHLY_UPDATE_DATA_DECISION.service"
# SERVICE_FILE_NAME_MONTHLY_UPDATE_DATABASE_UPDATER="$NAME_MONTHLY_UPDATE_DATABASE_UPDATER.service"
# SERVICE_FILE_NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR="$NAME_MONTHLY_UPDATE_GARBAGE_COLLECTOR.service"

SERVICE_USER=propertyprice
SERVICE_GROUP=propertyprice

BINARY_INSTALL_PATH_ROOT="/usr/local/bin/$APPLICATION_GROUP_NAME"
SYSTEMD_INSTALL_PATH_ROOT="/etc/systemd/system"
LOG_FILE_INSTALL_PATH_ROOT="/var/log/$APPLICATION_GROUP_NAME"
CONFIGURATION_FILE_INSTALL_PATH_ROOT="/etc"
CONFIGURATION_FILE_NAME="property_price_env"

BINARY_LOCAL_PATH_ROOT=".."
SERVICE_FILE_LOCAL_PATH_ROOT="../systemd-unit-service-files"
SERVICE_TARGET_FILE_NAME="land_registry_data.target"
CONFIGURATION_FILE_LOCAL_PATH_ROOT="../config"

# Create service user and group
echo "create user $SERVICE_USER and group $SERVICE_GROUP"
if ! id "$SERVICE_USER" &>/dev/null; then
    groupadd $SERVICE_GROUP
    useradd -r -s /bin/false -g $SERVICE_GROUP $SERVICE_USER
fi

# Create install directory
echo "create install directory $BINARY_INSTALL_PATH_ROOT"
mkdir -p "$BINARY_INSTALL_PATH_ROOT"

# Copy library dependencies
echo "copy library dependencies"
cp "$BINARY_LOCAL_PATH_ROOT/requirements.txt" "$BINARY_INSTALL_PATH_ROOT/"
cp -r "$BINARY_LOCAL_PATH_ROOT/lib_land_registry_download" "$BINARY_INSTALL_PATH_ROOT/"
pushd "$BINARY_INSTALL_PATH_ROOT"
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r requirements.txt
popd

# Copy python executables
for i in "${!PYTHON_NAMES[@]}"; do
    PYTHON_NAME="${PYTHON_NAMES[$i]}"
    echo "installing $PYTHON_NAME to $BINARY_INSTALL_PATH_ROOT"
    cp "$BINARY_LOCAL_PATH_ROOT/$PYTHON_NAME" "$BINARY_INSTALL_PATH_ROOT/"
done

# Ensure python executables are executable
for i in "${!PYTHON_NAMES[@]}"; do
    PYTHON_NAME="${PYTHON_NAMES[$i]}"
    echo "chmod +x $PYTHON_NAME"
    chmod +x "$BINARY_INSTALL_PATH_ROOT/$PYTHON_NAME"
done

# Copy systemd service files
echo "installing $SERVICE_TARGET_FILE_NAME to $SYSTEMD_INSTALL_PATH_ROOT"
cp "$SERVICE_FILE_LOCAL_PATH_ROOT/$SERVICE_TARGET_FILE_NAME" "$SYSTEMD_INSTALL_PATH_ROOT/"

for i in "${!SERVICE_FILE_NAMES[@]}"; do
    SERVICE_FILE_NAME="${SERVICE_FILE_NAMES[$i]}"
    echo "installing $SERVICE_FILE_NAME to $SYSTEMD_INSTALL_PATH_ROOT"
    cp "$SERVICE_FILE_LOCAL_PATH_ROOT/$SERVICE_FILE_NAME" "$SYSTEMD_INSTALL_PATH_ROOT/"
done

# Create target.wants directory
mkdir -p "$SYSTEMD_INSTALL_PATH_ROOT/$SERVICE_TARGET_FILE_NAME.wants"
# Create symlinks for services
for i in "${!SERVICE_FILE_NAMES[@]}"; do
    SERVICE_FILE_NAME="${SERVICE_FILE_NAMES[$i]}"
    ln -sf "$SYSTEMD_INSTALL_PATH_ROOT/$SERVICE_FILE_NAME" "$SYSTEMD_INSTALL_PATH_ROOT/$SERVICE_TARGET_FILE_NAME.wants/$SERVICE_FILE_NAME"
done

# Create log directory
echo "create log directory $LOG_FILE_INSTALL_PATH_ROOT"
mkdir -p "$LOG_FILE_INSTALL_PATH_ROOT"
chown propertyprice:propertyprice "$LOG_FILE_INSTALL_PATH_ROOT"
chmod 755 "$LOG_FILE_INSTALL_PATH_ROOT"

# Copy configuration environment file
cp "$CONFIGURATION_FILE_LOCAL_PATH_ROOT/$CONFIGURATION_FILE_NAME" "$CONFIGURATION_FILE_INSTALL_PATH_ROOT/"
chown propertyprice:propertyprice "$CONFIGURATION_FILE_INSTALL_PATH_ROOT/$CONFIGURATION_FILE_NAME"

# Reload systemctl to pick up new service files
echo "reload systemctl"
systemctl daemon-reload

echo "$APPLICATION_GROUP_NAME installation complete"
